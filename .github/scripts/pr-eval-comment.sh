#!/usr/bin/env bash
# PR Eval Comment — Posts or updates a quality score comment on a PR
#
# Reads /tmp/pr-eval-results.json (produced by pr-eval-l2.sh) and posts
# a formatted comment with star grading, dimension breakdown, and per-AC details.
#
# Idempotent: finds and updates an existing comment on re-runs (no spam).
#
# Required env vars:
#   GITHUB_TOKEN — GitHub token
#   PR_NUMBER    — Pull request number
#   REPO_OWNER   — Repository owner
#   REPO_NAME    — Repository name

set -euo pipefail

COMMENT_MARKER="<!-- pr-eval-bot -->"
RESULTS_FILE="/tmp/pr-eval-results.json"

# ---------------------------------------------------------------------------
# Read results
# ---------------------------------------------------------------------------
if [[ ! -f "$RESULTS_FILE" ]]; then
    echo "::warning::No results file found at $RESULTS_FILE — skipping comment"
    exit 0
fi

ISSUE_ID=$(jq -r '.issue_id' "$RESULTS_FILE")
TOTAL_SCORE=$(jq -r '.total_score' "$RESULTS_FILE")
TEST_SCORE=$(jq -r '.test_score' "$RESULTS_FILE")
COVERAGE_SCORE=$(jq -r '.coverage_score' "$RESULTS_FILE")
REVIEW_SCORE=$(jq -r '.review_score' "$RESULTS_FILE")
STAR_GRADE=$(jq -r '.star_grade' "$RESULTS_FILE")
GRADE_LABEL=$(jq -r '.grade_label' "$RESULTS_FILE")
SKIP_REASON=$(jq -r '.skip_reason // ""' "$RESULTS_FILE")
TRUNCATED=$(jq -r '.diff_truncated // false' "$RESULTS_FILE")

# Star display helper
score_to_stars() {
    local score=$1
    if   (( score >= 90 )); then echo "★★★★★"
    elif (( score >= 80 )); then echo "★★★★"
    elif (( score >= 70 )); then echo "★★★"
    elif (( score >= 60 )); then echo "★★"
    else echo "★"
    fi
}

TEST_STARS=$(score_to_stars "$TEST_SCORE")
COVERAGE_STARS=$(score_to_stars "$COVERAGE_SCORE")
REVIEW_STARS=$(score_to_stars "$REVIEW_SCORE")

# ---------------------------------------------------------------------------
# Merge policy display
# ---------------------------------------------------------------------------
if (( TOTAL_SCORE >= 80 )); then
    POLICY_LINE="✅ Score >= 80: Auto-approve quality gate"
elif (( TOTAL_SCORE >= 60 )); then
    POLICY_LINE="⚠️ Score 60-79: Merge allowed, human review recommended"
else
    POLICY_LINE="❌ Score < 60: Merge blocked — address gaps before merging"
fi

# ---------------------------------------------------------------------------
# Build per-AC breakdown
# ---------------------------------------------------------------------------
AC_SECTION=""
AC_COUNT=$(jq '.per_ac | length' "$RESULTS_FILE")
if (( AC_COUNT > 0 )); then
    AC_SECTION="
### Per-AC Breakdown
"
    for i in $(seq 0 $((AC_COUNT - 1))); do
        AC_TEXT=$(jq -r ".per_ac[$i].ac" "$RESULTS_FILE")
        ADDRESSED=$(jq -r ".per_ac[$i].addressed" "$RESULTS_FILE")
        EVIDENCE=$(jq -r ".per_ac[$i].evidence" "$RESULTS_FILE")

        if [[ "$ADDRESSED" == "true" ]]; then
            AC_SECTION+="- [x] $AC_TEXT — $EVIDENCE
"
        else
            AC_SECTION+="- [ ] $AC_TEXT — $EVIDENCE
"
        fi
    done
fi

# ---------------------------------------------------------------------------
# Build gaps section
# ---------------------------------------------------------------------------
GAPS_SECTION=""
GAP_COUNT=$(jq '.gaps | length' "$RESULTS_FILE")
if (( GAP_COUNT > 0 )); then
    GAPS_SECTION="
### Gaps
"
    for i in $(seq 0 $((GAP_COUNT - 1))); do
        GAP=$(jq -r ".gaps[$i]" "$RESULTS_FILE")
        GAPS_SECTION+="- $GAP
"
    done
fi

# ---------------------------------------------------------------------------
# Build skip notice (if applicable)
# ---------------------------------------------------------------------------
SKIP_NOTICE=""
if [[ -n "$SKIP_REASON" ]]; then
    SKIP_NOTICE="
> **Note:** Scoring used neutral defaults. Reason: $SKIP_REASON
"
fi

# ---------------------------------------------------------------------------
# Build truncation notice
# ---------------------------------------------------------------------------
TRUNC_NOTICE=""
if [[ "$TRUNCATED" == "true" ]]; then
    TRUNC_NOTICE="
> **Note:** PR diff was truncated to 100K characters. Some changes may not be reflected in the score.
"
fi

# ---------------------------------------------------------------------------
# Compose comment body
# ---------------------------------------------------------------------------
COMMENT_BODY="$COMMENT_MARKER
## PR Quality Score — $ISSUE_ID

| Dimension | Grade | Score | Details |
|-----------|-------|-------|---------|
| Test (40%) | $TEST_STARS | $TEST_SCORE | Test coverage and verification |
| Coverage (30%) | $COVERAGE_STARS | $COVERAGE_SCORE | Acceptance criteria addressed |
| Review (30%) | $REVIEW_STARS | $REVIEW_SCORE | Code quality and practices |

**Overall: $STAR_GRADE $GRADE_LABEL ($TOTAL_SCORE/100)**
$SKIP_NOTICE$TRUNC_NOTICE$AC_SECTION$GAPS_SECTION
### Merge Policy
$POLICY_LINE

---
*Generated by PR Eval Pipeline v0.1.0 • [Rubric: CCC quality-scoring](skills/quality-scoring/SKILL.md) • L3 deferred*"

# ---------------------------------------------------------------------------
# Find existing comment and update, or create new
# ---------------------------------------------------------------------------
EXISTING_COMMENT_ID=$(curl -sf \
    -H "Authorization: Bearer $GITHUB_TOKEN" \
    -H "Accept: application/vnd.github+json" \
    "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/issues/$PR_NUMBER/comments?per_page=100" \
    | jq -r ".[] | select(.body | startswith(\"$COMMENT_MARKER\")) | .id" \
    | head -1 || true)

BODY_JSON=$(jq -n --arg body "$COMMENT_BODY" '{ body: $body }')

if [[ -n "$EXISTING_COMMENT_ID" ]]; then
    echo "Updating existing comment $EXISTING_COMMENT_ID..."
    curl -sf \
        -X PATCH \
        -H "Authorization: Bearer $GITHUB_TOKEN" \
        -H "Accept: application/vnd.github+json" \
        -d "$BODY_JSON" \
        "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/issues/comments/$EXISTING_COMMENT_ID" > /dev/null
    echo "Comment updated."
else
    echo "Creating new comment..."
    curl -sf \
        -X POST \
        -H "Authorization: Bearer $GITHUB_TOKEN" \
        -H "Accept: application/vnd.github+json" \
        -d "$BODY_JSON" \
        "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/issues/$PR_NUMBER/comments" > /dev/null
    echo "Comment created."
fi
